---
layout: post
title:  "FASTCAT-ElasticSearch 테스트 - 검색+동적색인"
description: "ElasticSearch과 FASTCAT의 검색+동적색인 비교 테스트."
date:   2020.07.15.
writer: "하선호"
categories: Elastic
---

## 1. 개요
이번에는 검색과 동적색인이 동시에 발생했을 때의 테스트입니다. 실제 운영환경에서도 검색과 동적색인이 동시에 수행하여
 동적색인으로 변경되는 문서를 검색을 통해 확인할 수 있습니다. 여기서는 두 작업이 동시에 발생 할 때의 검색 성능의 변화에 중점을 두고 확인했습니다.

1) 색인 및 배포  
2) 검색  
3) 동적색인  
**4) 동적색인과 검색**  


## 2. 검색+동적색인 테스트

[검색+동적색인 테스트 구성도]

![/images/2020-07-15-Elasticsearch-SearchDynamicIndex/search-di-test-diagram.png](/images/2020-07-15-Elasticsearch-SearchDynamicIndex/search-di-test-diagram.png)

호출용 노드에서 검색과 동적색인을 동시에 Node1에 있는 검색엔진으로 호출합니다. 각각 검색과 동적색인 테스트에서 사용한 Jmeter와 동적색인 호출기를 사용하며 테스트는 각 검색엔진별로 순차적으로 진행합니다. 이전과 마찬가지로 5분동안 호출하며 동적색인은 9개의 볼륨에 요청하였습니다.

## 3. 검색+동적색인 테스트 결과

### 3-1. FASTCAT

 - FASTCAT의 경우 동적색인 API로 색인요청을 받더라도 해당 요청의 내용을 파일형태로 저장합니다. 그리고 내부적인 스케쥴 주기 (1초)마다 해당 파일들에 담긴 색인요청 정보로 색인을 진행합니다. 결과적으로 동적색인 요청으로 쌓인 문서들을 `bulk index`로 색인하는 형태가 됩니다. 아래는 비동기로 한건씩 호출한 요청들이 파일로 쌓이고 전부 처리될 때 까지의 결과입니다.


|쓰레드|호출수|평균 속도(ms)|최대 속도(ms)|TPS|CPU 사용률(%)|동적 색인 수|
|:------:|:---:|:---:|:---:|:---:|:---:|:---:|
|2|3,821|156|1989|12.7|Node1 : 58% , Node2 : 53%| 3,509,126 |
|4|7,553|158|1756|25.2|Node1 : 68% , Node2 : 67%| 3,281,147 |
|8|13,163|182|2691|43.8|Node1 : 76% , Node2 : 73%| 3,205,265 |
|16|15,398|311|2247|51.3|Node1 : 83% , Node2 : 75%| 3,143,177 |

### 기존 검색 테스트와 비교

|쓰레드|호출수||평균 속도(ms)||최대 속도(ms)||TPS||CPU 사용률(%)||
|:------:|:---:|:---:|:---:|:---:|:---:|:---:|:------:|:---:|:---:|:---:|:---:|
||**검색**|**검색+동적색인**|**검색**|**검색+동적색인**|**검색**|**검색+동적색인**|**검색**|**검색+동적색인**|**검색**|**검색+동적색인**|
|2|10,410|3,821|57.42|156|1194|1989|34.69|12.7|Node1 : 7.6% <br> Node2 : 6%|Node1 : 58% <br> Node2 : 53%|
|2|22303|3,821|53.65|156|1247|1989|74.21|12.7|Node1 : 15.8% <br> Node2 : 12.8%|Node1 : 58% <br> Node2 : 53%|
|4|33167|7,553|72.19|158|1733|1756|110.52|25.2|Node1 : 47.6% <br> Node2 : 38%|Node1 : 68% <br> Node2 : 67%|
|8|43965|13,163|108.95|182|2247|2691|146.49|43.8|Node1 : 90.8% <br> Node2 : 80.8%|Node1 : 76% <br> Node2 : 73%|

#### CPU 사용률

![/images/2020-07-09-Elasticsearch-DynamicIndex/di-test-fastcat-cpu.png](/images/2020-07-09-Elasticsearch-DynamicIndex/di-test-fastcat-cpu.png)


FASTCAT의 각 인덱스당 437만건의 색인을 처리했으며 약 1시간 20분 이후 쌓여있던 모든 동적색인 요청이 끝났습니다. CPU사용률은 Node1은 약 75%, Node2 약 50%입니다. Node1에서 받은 동적색인 요청을 Node2로도 보냈기 때문에 CPU를 더 사용하는 것 같습니다.

### 3-2. ElasticSearch

- 앞서 설명드리지 않았지만 색인기, 동적색인 호출기에서 ElasticSearch에 대한 REST API는 `High Level REST Client` 내의 API들을 사용합니다. 처음에는 동적색인의 경우 `indexAsync`로 비동기 요청하였지만 FASTCAT과는 다르게 ElasticSearch의 경우 `bulk index`로 처리되는 게 아니다보니 정상적인 테스트를 진행할 수가 없었습니다. 따라서 ElasticSearch 역시 특정 갯수만큼 상품을 묶어 `bulk index` 로 호출하는 형태로 테스트를 진행했습니다.

아래는 500개씩 묶어 동적색인을 요청 했을 때의 결과입니다.

|인덱스명|상품 수|색인 소요 시간|
|:------:|:---:|:---:|
|V2|4,377,840|0:55:14|
|V3|4,377,840|0:55:14|
|V4|4,377,839|0:55:14|
|V5|4,377,839|0:55:14|
|V6|4,377,839|0:55:14|
|V7|4,377,839|0:55:14|
|V8|4,377,839|0:55:14|
|V9|4,377,839|0:55:14|
|V10|4,377,839|0:55:14|

#### CPU 사용률

![/images/2020-07-09-Elasticsearch-DynamicIndex/di-test-es-cpu.png](/images/2020-07-09-Elasticsearch-DynamicIndex/di-test-es-cpu.png)


마찬가지로 인덱스당 437건의 색인을 처리했고 모두 호출하여 처리하는데 55분정도가 소요되었습니다. CPU는 Node1은 9% Node2는 8%를 사용했습니다. FASTCAT과 비해 약 30%정도 빨라졌고 CPU 사용률 역시 약 80%정도 감소했습니다.


## 4. 결론
이번 테스트에서는 검색엔진이 각각 처리하는 방식이 달라 기준을 어떻게 맞춰서 테스트 해야할지가 고민되었습니다.
결과적으로 두 검색엔진이 `bulk index`로 처리되는 형태로 진행했으며 ElasticSearch의 성능이 FASTCAT보다 소요시간은 더 짧고 CPU 사용률도 크게 줄었음을 확인했습니다.

다음 블로그는 검색과 동적색인이 동시에 발생 했을 때의 테스트입니다.


## 참고 자료
- https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-high-document-index.html