---
layout: post
title:  "[ElasticSearch] 색인 테스트"
description: "다나와에선 검색엔진을 패스트캣을 사용하고 있습니다. 다나와는 차세대 검색엔진을 엘라스틱서치를 고려하고 있습니다. 엘라스틱은 다양한 서비스를 제공하고 있고, 검색/색인 성능도 좋게 평가되고 있기 때문입니다. 이번에 포스팅 내용은 엘라스틱으로 색인성능을 테스트 해보도록 하겠습니다."
date:   2020.03.11.
writer: "김준우"
categories: Elastic
---

## 소개

다나와에선 검색엔진을 [패스트캣]([http://www.fastcat.co/](http://www.fastcat.co/))을 사용하고 있습니다. 다나와는 차세대 검색엔진을 엘라스틱서치를 고려하고 있습니다. 엘라스틱은 다양한 서비스를 제공하고 있고, 검색/색인 성능도 좋게 평가되고 있기 때문입니다. 이번에 포스팅 내용은 엘라스틱으로 색인성능을 테스트 해보도록 하겠습니다.

## 테스트방법

500만건의 문서가 있는 파일을 로그스태시로 엘라스틱서치에 문서를 등록합니다.  엘라스틱 서치의 인덱스 설정을 조정하며 시스템 자원 소모및 소요시간등을 기록하였습니다. 그리고 엘라스틱서치를 싱글노드일때와  클러스터 노드일때 각각 환경에서 테스트를 진행하였습니다.

### 테스트 조건

문서

- 갯수 : 5011608건
- 문서 크기: 약 5.27GB

엘라스틱서치 

- 노드: 1(싱글), 3(클러스터)
- 힙메모리: 1GB (싱글), 16GB(클러스터)

시스템 자원 

- core:  48
- memory: 94G

클러스터 환경에서 테스트 진행시 시스템 자원을 동일하게 구성하였습니다.

## 테스트 결과

### 싱글모드

1. shards: 1, replicas: 0
    1. 소요시간:  0:23:33
    2. 문서 크기: 1.6GB
    3. CPU 사용률: 최소: 12 %, 최대: 260 %, 평균: 75%, 최빈수: 66 %
    4. 메모리 평균 수치: 1.5GB 
2. shards: 1, replicas: 1
    1. 소요시간:  0:26:28
    2. 문서 크기: 1.6GB
    3. CPU: 최소: 6.7 %, 최대: 233.3 %, 평균: 66.2 %, 최빈수: 60.0 %
    4. 메모리 평균 수치: 1.6GB
    5. 특이사항: 인덱스 상태가 yellow
3. shards: 5, replicas: 0
    1. 소요시간: 1:13:34
    2. 문서 크기: 2.2GB
    3. CPU: 최소 6.2%, 최대: 246.7%, 평균: 28.2%, 최빈수: 20%
    4. 메모리 평균 수치: 1.5GB
4. reindex 진행 (shards: 1, replicas: 0)
    1. 소요시간: 0:17:32
    2. 문서 크기: 1.6GB
    3. CPU: 최소 46.7%, 최대 231.2%, 평균 105.3% 최빈수 86.7% 
    4. 메모리 평균 수치:  1.8GB
5. snapshot (shards: 1, replicas: 0)
    1. 소요시간: 59s
    2. 문서 크기: 1.7GB
    3. CPU: 최소 6.7%, 최대 93.3%, 평균 20%, 최빈수: 6.7%
    4. 메모리 평균 수치: 1.4GB
    5. 특이사항: restore는 1초 이내 완료됨. 
6. 문서 전체 삭제 (shards: 1, replicas: 0)
    1. 소요시간: 0:21:47
    2. CPU: 최소 6.7%, 최대 306.7%, 평균 97.8%, 최빈수 100%
    3. 메모리 평균수치: 1.98GB
    4. 특이사항: 전체삭제는 인덱스를 지우는게 빠름

### 클러스터 모드

전체 노드 메모리 평균수치: 18.4G

1. shards: 1, replicas: 0
    1. 소요시간:  0:05:30
    2. 문서 크기: 1.8G
    3. CPU: 최소 6.7%, 최대 60%, 평균 29.2%, 최빈수 33.3%
2. shards: 2, replicas: 0
    1. 소요시간:  0:05:10
    2. 문서 크기: 1.9GB
    3. CPU: 최소 75%, 최대 1347%, 평균 249.4%, 최빈수 140%
3. shards: 3, replicas: 0
    1. 소요시간:  0:05:41
    2. 문서 크기: 1.9GB
    3. CPU: 최소 6.7%, 최대 646.7%, 평균 169.3%, 최빈수 140%
4. shards: 5, replicas: 0
    1. 소요시간: 0:05:10
    2. 문서 크기: 1.9G
    3. CPU: 최소 6.7%, 최대 186.7%, 평균 111.3%, 최빈수 120%
5. shards: 1, replicas: 1
    1. 소요시간: 0:07:13
    2. 문서 크기: 3.8G
    3. CPU: 최소 6.7%, 최대 1687%, 평균 496.5%, 최빈수 346.7%
6. shards: 5, replicas: 1
    1. 소요시간: 0:06:42
    2. 문서 크기: 3.8G
    3. CPU: 최소 6.7%, 최대 620%, 평균 216%, 최빈수 6.7%
7. replicas 변경 (shards: 1, replicas: 0 → 1)
    1. 소요시간: 0:01:44
    2. 문서 크기: 1.8G → 3.6G
    3. CPU: 최소 6.7%, 최대 46%, 평균 24.3%
8. replicas 변경 (shards: 5, replicas: 0 → 1)
    1. 소요시간: 0:01:02
    2. 문서 크기: 1.8G → 3.7G
    3. CPU: 최소 6.7%, 최대 26.7%, 평균 14.5%, 최빈수 13.3%

## 정리

색인과 스냅샷등의 성능 테스트를 진행해보았습니다.  싱글모드일때는 replicas를 1이상으로 지정해도 데이터크기가 변하지 않는 현상이 었었습니다. 노드가 1개일때 primary가 이미 저장되어 있어서  replicas가 적용 안되는 현상같았습니다. 그리고 샤드의 갯수에 따라 색인 성능 차이가 있고, 데이터의 크기도 차이가 있었습니다. 클러스터 환경에서는 월등히 빠른 색인 성능을 보여주었고, replicas에 따른 문서 크기도 달라졌습니다. 엘라스틱서치를 사용을 고려할때 이번 포스트이 도움이 되었으면 합니다.